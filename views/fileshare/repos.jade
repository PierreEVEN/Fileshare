extends fileshare

block files

    - function humanFileSize(bytes) {
    -   const thresh = 1024;

    -   if (Math.abs(bytes) < thresh) {
    -     return bytes + ' B';
    -   }

    -   const units = ['ko', 'Mo', 'Go', 'To', 'Po', 'Eo', 'Zo', 'Yo']
    -   let u = -1;
    -   const r = 10;
    -   do {
    -     bytes /= thresh;
    -     ++u;
    -   } while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);
    -   return bytes.toFixed(1) + ' ' + units[u];
    - }
    link(href="https://vjs.zencdn.net/8.5.2/video-js.css", rel="stylesheet")
    link(href='/stylesheets/fileshare/item-preview.css', rel='stylesheet')
    each item in locals.session_data.selected_repos.content
        - item.url = '/fileshare/repos/' + locals.session_data.selected_repos.access_key + '/file/' + item.id
        div.object-button(onclick='open_this_item(this, "' + item.name + '","' + item.url + '","' + item.size + '","' + item.mimetype + '")')
            include item-preview

    script(src="https://vjs.zencdn.net/8.5.2/video.min.js")


    script.
        function open_this_item(div, name, url, size, mimetype) {
            const new_div = document.createElement('div');
            new_div.classList.add('item-plain')
            if (div) {
                new_div.style.width = div.getBoundingClientRect().width + 'px';
                new_div.style.height = div.getBoundingClientRect().height + 'px';
                new_div.style.left = div.getBoundingClientRect().x + 'px';
                new_div.style.top = div.getBoundingClientRect().y + 'px';
            } else {
                new_div.style.width = '100%';
                new_div.style.height = '100%';
                new_div.style.left = '0';
                new_div.style.top = '0';
            }

            if (document.last_selected_item)
                document.last_selected_item.remove();

            document.last_selected_item = new_div;
            document.body.append(new_div)

            new_div.innerHTML = gen_item(name, url, size, mimetype);
            new_div.onclick = (e) => {
                if (e.target === document.last_selected_item)
                    close_item_plain();
            }
        }

        document.onkeydown = (e) => {
            if (e.key === "Escape") { // escape key maps to keycode `27`
                close_item_plain();
            }
        }

        function close_item_plain() {
            if (document.last_selected_item)
                document.last_selected_item.remove()
            document.last_selected_item = null
        }

        function gen_item(name, url, size, mimetype) {
            if (mimetype.startsWith('image/'))
                return `<img src="${url}" alt="${name}">`
            else if (mimetype === 'text/plain')
                return `<img src="https://img.icons8.com/?size=512&id=12053" alt="document">`
            else if (mimetype === 'application/pdf')
                return `<img src="https://img.icons8.com/?size=512&id=13417" alt="document">`
            else if (mimetype === 'application/octet-stream')
                return `<img src="https://img.icons8.com/?size=512&id=38992" alt="document">`
            else if (mimetype.startsWith('video/'))
                return `<video id="my-video" class="video-js" controls width="100%" height="90%" preload="auto" data-setup="{}">
                    <source src="${url}" type="${mimetype}">
                    <p class="vjs-no-js"> To view this video please enable JavaScript, and consider upgrading to a web browser that
                    </p>
                    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>
                </video>`

            return `<p>${name}</p>`
        }